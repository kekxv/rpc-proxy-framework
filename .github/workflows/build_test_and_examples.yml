name: Build, Test and Examples RPC Proxy Framework

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-examples-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libffi-dev cmake g++ python3 python3-pip openjdk-17-jdk maven

    - name: Build Executor
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release

    - name: Test
      run: ctest --test-dir build --output-on-failure
      timeout-minutes: 1

    - name: Build Test Lib
      run: |
        cmake -B test_lib/build test_lib
        cmake --build test_lib/build

    - name: Run Python Example
      timeout-minutes: 1
      run: |
        build/executor --pipe my_pipe & 
        EXECUTOR_PID=$!
        sleep 2
        python3 examples/python_controller/controller.py my_pipe
        kill $EXECUTOR_PID
        rm /tmp/my_pipe # Clean up Unix domain socket

    - name: Build Java Example
      run: |
        cd examples/java_controller
        mvn clean install
        cd ../..

    - name: Run Java Example
      timeout-minutes: 1
      run: |
        build/executor --pipe my_pipe & 
        EXECUTOR_PID=$!
        sleep 3
        java -jar examples/java_controller/target/java-controller-1.0-SNAPSHOT-jar-with-dependencies.jar my_pipe
        kill $EXECUTOR_PID
        rm /tmp/my_pipe # Clean up Unix domain socket

    - name: Build C++ Example
      timeout-minutes: 1
      run: |
        cmake -B examples/cpp_controller/build -DCMAKE_BUILD_TYPE=Release examples/cpp_controller
        cmake --build examples/cpp_controller/build

    - name: Run C++ Example
      run: |
        build/executor --pipe my_pipe & 
        EXECUTOR_PID=$!
        sleep 2
        examples/cpp_controller/build/cpp_controller_example my_pipe
        kill $EXECUTOR_PID
        rm /tmp/my_pipe # Clean up Unix domain socket

  build-linux:
    runs-on: ubuntu-latest
    needs: [test-examples-linux]
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libffi-dev cmake g++

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Test
      run: ctest --test-dir build --output-on-failure
      timeout-minutes: 1

  build-windows-x64:
    runs-on: windows-latest
    needs: [test-examples-linux]
    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake (x64)
      run: cmake -B build -A x64 -DCMAKE_BUILD_TYPE=Release

    - name: Build (x64)
      run: cmake --build build --config Release

    - name: Test (x64)
      run: ctest --test-dir build --output-on-failure -C Release
      timeout-minutes: 1

    - name: Package and Upload Win64 Artifacts
      shell: pwsh
      run: |
        $buildDir = "build"
        $outputDir = "."
        New-Item -ItemType Directory -Force -Path $outputDir
        Copy-Item -Path "$buildDir\Release\executor.exe" -Destination $outputDir
        # Assuming libffi-8.dll is in the build directory or a known path
        # If not found, this step will fail and needs adjustment
        Copy-Item -Path "$buildDir\Release\libffi-8.dll" -Destination $outputDir -ErrorAction SilentlyContinue
        # If libffi-8.dll is not in Release, try other common locations
        if (-not (Test-Path "$outputDir\libffi-8.dll")) {
            Copy-Item -Path "libffi\x86-64bit-msvc-binaries\libffi-8.dll" -Destination $outputDir -ErrorAction SilentlyContinue
        }
    - uses: actions/upload-artifact@v4
      with:
        name: win64-executor
        path: |
          executor.exe
          libffi-8.dll

  build-windows-x86:
    runs-on: windows-latest
    needs: [test-examples-linux]
    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake (x86)
      run: cmake -B build -A Win32 -DCMAKE_BUILD_TYPE=Release

    - name: Build (x86)
      run: cmake --build build --config Release

    - name: Test (x86)
      run: ctest --test-dir build --output-on-failure -C Release
      timeout-minutes: 1

    - name: Package and Upload Win32 Artifacts
      shell: pwsh
      run: |
        $buildDir = "build"
        $outputDir = "."
        New-Item -ItemType Directory -Force -Path $outputDir
        Copy-Item -Path "$buildDir\Release\executor.exe" -Destination $outputDir
        # Assuming libffi-8.dll is in the build directory or a known path
        # If not found, this step will fail and needs adjustment
        Copy-Item -Path "$buildDir\Release\libffi-8.dll" -Destination $outputDir -ErrorAction SilentlyContinue
        # If libffi-8.dll is not in Release, try other common locations
        if (-not (Test-Path "$outputDir\libffi-8.dll")) {
            Copy-Item -Path "libffi\x86-32bit-msvc-binaries\libffi-8.dll" -Destination $outputDir -ErrorAction SilentlyContinue
        }
    - uses: actions/upload-artifact@v4
      with:
        name: win32-executor
        path: |
          executor.exe
          libffi-8.dll
